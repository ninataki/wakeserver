#!/usr/bin/python

import os
import sys
import signal
import time
import json
from collections import namedtuple
from wakeserver import monitoring, plugin

PIDFILE =          "/run/wakeserverd.pid"
STATUS_DIR =       "/run/wakeserver"
ERROR_FILE =       "/run/wakeserver/error"
MAIN_CONF =        "/var/www/wakeserver/wakeserver.conf"
SERVERS_CONF =     "/var/www/wakeserver/servers.conf"

def daemonize(inDebug):
    if not inDebug:
        os.chdir("/")

    if not os.path.isdir(STATUS_DIR):
        os.mkdir(STATUS_DIR)
    if not inDebug:
        sys.stdin.close()
        sys.stdout.close()
        sys.stderr.close()
        sys.stdin = open("/dev/null", "r")
        sys.stdout = open("/dev/null", "w")
        sys.stderr = open(ERROR_FILE, "w")

    return True

def main():
    if daemonize('DEBUG' in os.environ):
        conf = namedtuple('Config', ('main', 'servers'))
        with open(MAIN_CONF) as f:
            conf.main = json.load(f)
            
        with open(SERVERS_CONF) as f:
            conf.servers = json.load(f)

        pool = plugin.PluginPool(conf)
        daemon = monitoring.Monitor(conf, pool)
        daemon.run()

if __name__ == '__main__':
    signal.signal(signal.SIGINT, lambda sig, frame: sys.exit(1))
    main()
    sys.exit(0)
